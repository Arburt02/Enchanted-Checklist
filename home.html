<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Enchanted Checklist</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- ðŸŒ“ Instant theme hint (prevents flash on first paint) -->
  <script>
  (function () {
    try {
      const cached = localStorage.getItem('ec_dark');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (cached === 'true' || (cached === null && prefersDark)) {
        document.documentElement.classList.add('dark');
      }
    } catch (e) {}
  })();
  </script>

  <style>
    /* ===== Base page background ===== */
    body {
      margin: 0;
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #c2e9fb 0%, #a1c4fd 50%, #fbc2eb 100%);
      color: white;
      padding: 2rem;
      min-height: 100vh;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      overflow-x: hidden;
    }

    /* Light-mode mural layer */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('Mural.PNG') no-repeat center top;
      background-size: contain;
      opacity: 0.20;
      pointer-events: none;
      z-index: 0;
    }
    body > * { position: relative; z-index: 1; }

    /* ===== Layout ===== */
    .main-container { width: 95%; max-width: 700px; margin: 0 auto; padding: 1rem; }
    @media (min-width: 768px) { .main-container { width: 80%; } }
    @media (min-width: 1024px){ .main-container { width: 60%; } }

    /* ===== Reusable glass surface (matches checklist) ===== */
    .glass {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 12px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* Hero header card */
    .hero {
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.25rem;
    }
    .hero h1 { margin: 0 0 0.35rem 0; text-align: center; font-size: 2rem; }
    .hero p  { margin: 0.25rem 0 0; text-align: center; }

    /* ===== Buttons (unified) ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      width: 100%;
      max-width: 300px;
      padding: .7rem 1rem;
      margin: .35rem 0;
      border: 0;
      border-radius: 10px;
      font: 600 1rem 'Poppins', sans-serif;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transition: transform .06s ease, box-shadow .12s ease, background-color .12s ease;
    }
    .btn:active { transform: translateY(1px); box-shadow: 0 3px 10px rgba(0,0,0,.18); }

    .btn-primary { background:#ffffff; color:#2f77a7; }
    .btn-primary:hover { background: rgba(255,255,255,0.9); }

    .btn-ghost  { background: rgba(255,255,255,0.10); color:#ffffff; border:1px solid rgba(255,255,255,0.25); }
    .btn-ghost:hover { background: rgba(255,255,255,0.18); }

    /* ===== Progress rings ===== */
    #progress-rings-card { padding: 1.25rem; margin-top: 1rem; }
    #progress-rings-container { display:flex; align-items:center; justify-content:center; gap:2rem; max-width:700px; margin: 0 auto; }
    #progress-rings-container svg { width: 280px; height: 280px; }
    #progress-rings-container .animated-ring { filter: url(#glow); transition: stroke-dashoffset 1.5s ease-out; }
    @media (prefers-reduced-motion: reduce) {
      #progress-rings-container .animated-ring { transition: none; }
    }
    .ring-labels { display:flex; flex-direction:column; justify-content:center; gap:1rem; font-size:.95rem; text-align:left; }

    @keyframes pulseGlow {
      0% { filter: drop-shadow(0 0 4px rgba(255,255,255,0.3)); }
      50% { filter: drop-shadow(0 0 10px rgba(255,255,255,0.7)); }
      100% { filter: drop-shadow(0 0 4px rgba(255,255,255,0.3)); }
    }
    .pulse-once { animation: pulseGlow 1.2s ease-out; }

    /* ===== Dark mode ===== */
    html.dark body, body.dark { background:#121212; color:white; }

    /* Dark-mode mural becomes white mask */
    html.dark body::before,
    body.dark::before {
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      -webkit-mask-image:url('Mural.PNG'); mask-image:url('Mural.PNG');
      -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
      -webkit-mask-position:center top; mask-position:center top;
      -webkit-mask-size:contain; mask-size:contain;
      background-color: rgba(255,255,255,0.30);
      opacity: .3;
      background-image: none;
    }

    /* Glass in dark mode (same blur, darker glass) */
    html.dark .glass, body.dark .glass {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
  </style>
</head>

<body style="display:none;">
  <div class="main-container" id="mainContent" style="display:none;">

    <!-- Glass hero header (matches checklist look) -->
    <div class="glass hero">
      <h1><i class="fas fa-wand-magic-sparkles" style="margin-right:.5rem;"></i>The Enchanted Checklist</h1>
      <p>Your Ultimate Guide to Completing Disney!</p>
      <div id="tripCountdown" style="display:none; font-size:1rem; margin-top:.5rem; text-align:center;">
        <i class="fas fa-calendar-day"></i> <span id="tripCountdownText"></span>
      </div>
    </div>

    <!-- Progress rings card -->
    <div id="progress-rings-card">
      <div id="progress-rings-container">
        <svg viewBox="0 0 280 280" aria-hidden="true">
          <defs>
            <filter id="glow"><feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="#000000" flood-opacity="0.25"/></filter>
          </defs>

          <!-- Background rings -->
          <circle cx="140" cy="140" r="115" stroke="#deb6ee" stroke-width="10" fill="none" opacity="0.2"/>
          <circle cx="140" cy="140" r="90"  stroke="#dc81ff" stroke-width="10" fill="none" opacity="0.2"/>
          <circle cx="140" cy="140" r="60"  stroke="#c075e4" stroke-width="10" fill="none" opacity="0.2"/>
          <circle cx="140" cy="140" r="35"  stroke="#89cff0" stroke-width="10" fill="none" opacity="0.2"/>

          <!-- Foreground (animated) -->
          <circle id="ring-total" class="animated-ring" cx="140" cy="140" r="115" stroke="#deb6ee" stroke-width="10" fill="none"
                  stroke-linecap="round" transform="rotate(-90 140 140)" stroke-dasharray="722.6" stroke-dashoffset="722.6" filter="url(#glow)" />
          <circle id="ring-wdw"   class="animated-ring" cx="140" cy="140" r="90"  stroke="#dc81ff" stroke-width="10" fill="none"
                  stroke-linecap="round" transform="rotate(-90 140 140)" stroke-dasharray="565.5" stroke-dashoffset="565.5" filter="url(#glow)" />
          <circle id="ring-dl"    class="animated-ring" cx="140" cy="140" r="60"  stroke="#c075e4" stroke-width="10" fill="none"
                  stroke-linecap="round" transform="rotate(-90 140 140)" stroke-dasharray="376.9" stroke-dashoffset="376.9" filter="url(#glow)" />
          <circle id="ring-dcl"   class="animated-ring" cx="140" cy="140" r="35"  stroke="#89cff0" stroke-width="10" fill="none"
                  stroke-linecap="round" transform="rotate(-90 140 140)" stroke-dasharray="219.9" stroke-dashoffset="219.9" filter="url(#glow)" />
        </svg>

        <div class="ring-labels">
          <div id="percent-total"><i class="fas fa-bullseye"></i> Total: --%</div>
          <div id="percent-wdw"><i class="fas fa-landmark-dome"></i> WDW: --%</div>
          <div id="percent-dl"><i class="fas fa-bridge"></i> DLR: --%</div>
          <div id="percent-dcl"><i class="fas fa-anchor"></i> DCL: --%</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div style="margin-top: 1.25rem; display:flex; flex-direction:column; align-items:center; gap:.6rem;">
      <div style="margin-top: 1.25rem; display:flex; flex-direction:column; align-items:center; gap:.6rem;">
  <button class="btn btn-primary" onclick="loadExperiences()"><i class="fas fa-map-marked-alt"></i> Your Experiences</button>
  <button class="btn btn-primary" onclick="openFavorites()"><i class="fas fa-heart"></i> Favorites</button>
  <button class="btn btn-primary" onclick="window.location.href='planner.html'"><i class="fas fa-calendar-check"></i> My Trip Planner</button>

  <a class="btn btn-primary" href="https://ko-fi.com/theenchantedchecklist" target="_blank" rel="noopener">
    <i class="fas fa-mug-hot"></i> Support the Project on Koâ€‘fi
  </a>

  <!-- switched from btn-ghost â†’ btn-primary -->
  <button class="btn btn-primary" onclick="window.location.href='contact.html'"><i class="fas fa-envelope"></i> Contact Us</button>
  <button class="btn btn-primary" onclick="window.location.href='preferences.html'"><i class="fas fa-cog"></i> Preferences</button>
  <button class="btn btn-primary" onclick="logout()"><i class="fas fa-door-open"></i> Logout</button>
    </div>

    <!-- Howâ€‘to video card -->
    <div class="glass" style="margin-top:1.25rem; padding:1rem; text-align:center;">
      <h3 style="margin:0 0 .5rem 0;">ðŸŽ¥ How to Use This App</h3>
      <p style="font-size:.95rem; margin:0 0 1rem 0;">Watch this quick walkthrough to get started using The Enchanted Checklist!</p>
      <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.25);">
        <iframe
          src="https://www.youtube.com/embed/k1Uwe5fObYM"
          title="How to Use The Enchanted Checklist"
          frameborder="0"
          allowfullscreen
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:12px;">
        </iframe>
      </div>
    </div>
  </div>

  <!-- ðŸ”§ App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, getDoc, getDocs, doc, collection } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLDycGnK6Nm8m5KqbhhPSKz7GNb3PjZCo",
      authDomain: "the-enchanted-checklist.firebaseapp.com",
      projectId: "the-enchanted-checklist",
      storageBucket: "the-enchanted-checklist.appspot.com",
      messagingSenderId: "971177969419",
      appId: "1:971177969419:web:3a48e119cb866f6551840e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Nav helpers
    window.loadExperiences = () => window.location.href = "checklist.html";
    window.openFavorites   = () => window.location.href = "favorites.html";
    window.openPreferences = () => window.location.href = "preferences.html";
    window.logout = async () => { try { await signOut(auth); window.location.href = "index.html"; } catch (e) { alert("Logout failed: " + e.message); } };

    // Ring pulse helper
    function pulse(ringId) {
      const el = document.getElementById(ringId);
      if (!el) return;
      el.classList.remove("pulse-once");
      void el.offsetWidth;
      el.classList.add("pulse-once");
    }

    async function updateGlobalProgress() {
      const user = auth.currentUser;
      if (!user) return;

      const uid = user.uid;
      const [checklistRes, progressSnap, prefsSnap] = await Promise.all([
        fetch("checklist.json").then(r => r.json()),
        getDocs(collection(db, `users/${uid}/progress`)),
        getDoc(doc(db, `users/${uid}/preferences/default`))
      ]);

      const progressMap = {};
      progressSnap.forEach(d => { progressMap[d.id] = d.data().complete === true; });

      const prefs = prefsSnap.exists() ? prefsSnap.data() : {};
      const wdwParks = ["Magic Kingdom","EPCOT","Animal Kingdom","Hollywood Studios","Park Hopper Plus","Disney Springs","Walt Disney World Resorts"];
      const dlrParks = ["Disneyland Park","Disney California Adventure","Downtown Disney District","Disneyland Resorts","Seasonal Events and Festivals","Bonus"];
      const wdwFilters = Object.fromEntries(wdwParks.map(p => [p, prefs[`include_${p}`] !== false]));
      const dlrFilters = Object.fromEntries(dlrParks.map(p => [p, prefs[`include_${p}`] !== false]));
      const dclFilter  = prefs["include_Disney Cruise Line"] !== false;

      const filtered = checklistRes.filter(task => {
        if (task.Experience === "Walt Disney World") return wdwFilters[task.Park];
        if (task.Experience === "Disneyland")        return dlrFilters[task.Park];
        if (task.Experience === "Disney Cruise Line")return dclFilter;
        return false;
      });

      const wdw = filtered.filter(t => t.Experience === "Walt Disney World");
      const dl  = filtered.filter(t => t.Experience === "Disneyland");
      const dcl = filtered.filter(t => t.Experience === "Disney Cruise Line");

      let totalComplete=0, wdwComplete=0, dlComplete=0, dclComplete=0;
      filtered.forEach(task => {
        const id = task.id || `${task.Park}-${task.Area}-${task.Task}`;
        if (progressMap[id]) {
          totalComplete++;
          if (task.Experience === "Walt Disney World") wdwComplete++;
          if (task.Experience === "Disneyland")        dlComplete++;
          if (task.Experience === "Disney Cruise Line")dclComplete++;
        }
      });

      const totalPercent = totalComplete / filtered.length || 0;
      const wdwPercent   = wdwComplete   / wdw.length     || 0;
      const dlPercent    = dlComplete    / dl.length      || 0;
      const dclPercent   = dclComplete   / dcl.length     || 0;

      document.getElementById("ring-total").style.strokeDashoffset = 722.6 * (1 - totalPercent); pulse("ring-total");
      document.getElementById("ring-wdw").style.strokeDashoffset   = 565.5 * (1 - wdwPercent);   pulse("ring-wdw");
      document.getElementById("ring-dl").style.strokeDashoffset    = 376.9 * (1 - dlPercent);    pulse("ring-dl");
      document.getElementById("ring-dcl").style.strokeDashoffset   = 219.9 * (1 - dclPercent);   pulse("ring-dcl");

      document.getElementById("percent-total").innerHTML = `<i class="fas fa-bullseye"></i> Total: ${(totalPercent*100).toFixed(1)}% â€” ${totalComplete}/${filtered.length}`;
      document.getElementById("percent-wdw").innerHTML   = `<i class="fas fa-landmark-dome"></i> WDW: ${(wdwPercent*100).toFixed(1)}% â€” ${wdwComplete}/${wdw.length}`;
      document.getElementById("percent-dl").innerHTML    = `<i class="fas fa-bridge"></i> DLR: ${(dlPercent*100).toFixed(1)}% â€” ${dlComplete}/${dl.length}`;
      document.getElementById("percent-dcl").innerHTML   = `<i class="fas fa-anchor"></i> DCL: ${(dclPercent*100).toFixed(1)}% â€” ${dclComplete}/${dcl.length}`;
    }

    function showLandingPage() {
      document.getElementById("landingPage")?.style.setProperty('display','block'); // no-op if absent
      updateGlobalProgress();
      const rings = document.getElementById("progress-rings-container");
      if (rings) { rings.classList.remove("pulse-once"); void rings.offsetWidth; rings.classList.add("pulse-once"); }
    }

    // ðŸ” Auth + theme (no flash)
    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = "index.html"; return; }

      const prefsSnap = await getDoc(doc(db, `users/${user.uid}/preferences/default`));
      const prefs = prefsSnap.exists() ? prefsSnap.data() : {};

      // Apply dark and cache before reveal
      if (prefs.dark_mode === true) { document.body.classList.add("dark"); try { localStorage.setItem('ec_dark','true'); } catch {} }
      else { document.body.classList.remove("dark"); try { localStorage.setItem('ec_dark','false'); } catch {} }

      // Reveal UI after theme is set
      document.body.style.display = "block";
      document.getElementById("mainContent").style.display = "block";
      showLandingPage();

      // Trip countdown
      const tripDateStr = prefs.tripStartDate;
      const countdown  = document.getElementById("tripCountdown");
      const textEl     = document.getElementById("tripCountdownText");
      if (tripDateStr) {
        const today = new Date();
        const trip  = new Date(tripDateStr);
        const days  = Math.ceil((trip - today) / (1000*60*60*24));
        let msg = "";
        if (days > 0) msg = `${days} day(s) until your next Disney adventure!`;
        else if (days === 0) msg = `<i class="fas fa-star" style="margin-right:.4rem;"></i>Today is your trip day!`;
        else msg = `<i class="fas fa-suitcase-rolling" style="margin-right:.4rem;"></i>Your selected trip date has passed.`;
        textEl.innerHTML = msg; countdown.style.display = "block";
      }
    });
  </script>
</body>
</html>